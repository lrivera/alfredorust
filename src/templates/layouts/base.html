<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>{% block title %}Panel{% endblock %}</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
  <style>
    .flatpickr-calendar {
      border-radius: 14px;
      border: 1px solid rgb(203 213 225);
      box-shadow: 0 10px 30px -12px rgba(15, 23, 42, 0.35);
      overflow: hidden;
    }
    .flatpickr-months .flatpickr-month {
      height: 48px;
      padding-top: 6px;
      background: linear-gradient(90deg, rgb(59 130 246 / 0.18), rgb(56 189 248 / 0.18));
      color: rgb(15 23 42);
      font-weight: 600;
    }
    .flatpickr-day.selected,
    .flatpickr-day.startRange,
    .flatpickr-day.endRange {
      background: linear-gradient(135deg, #0ea5e9, #2563eb);
      border-color: transparent;
      color: white;
      box-shadow: 0 6px 18px -8px rgba(37, 99, 235, 0.8);
    }
    .flatpickr-day.today {
      border-color: #0ea5e9;
      color: #0ea5e9;
    }
    .flatpickr-time input,
    .flatpickr-time .numInputWrapper span.arrowUp:after,
    .flatpickr-time .numInputWrapper span.arrowDown:after {
      color: rgb(30 41 59);
    }
    .flatpickr-time input {
      font-weight: 600;
    }
  </style>
  {% block head %}{% endblock %}
</head>
<body class="min-h-screen bg-slate-100 text-slate-900">
  <div class="min-h-screen flex flex-col">
    <header class="bg-white/70 backdrop-blur border-b border-slate-200">
      <nav class="w-full flex flex-wrap items-center gap-4 px-6 py-4">
        <a href="/" class="text-lg font-semibold text-sky-700 whitespace-nowrap">Axum TOTP</a>
        <div class="flex-1">
          <div id="navAuth" class="hidden flex flex-wrap items-center justify-end gap-3 text-sm font-medium text-slate-600">
            <a data-nav href="/" class="hover:text-sky-600 transition">Inicio</a>
            <a data-nav href="/account" class="hover:text-sky-600 transition">Mi cuenta</a>
            <a data-nav data-role="admin-only" href="/admin/users" class="hover:text-sky-600 transition">Usuarios</a>
            <a data-nav href="/admin/companies" class="hover:text-sky-600 transition">Compañías</a>
            <a data-nav data-role="admin-only" href="/admin/accounts" class="hover:text-sky-600 transition">Cuentas</a>
            <a data-nav data-role="admin-only" href="/admin/categories" class="hover:text-sky-600 transition">Categorías</a>
            <a data-nav data-role="admin-only" href="/admin/contacts" class="hover:text-sky-600 transition">Contactos</a>
            <a data-nav data-role="admin-only" href="/admin/recurring_plans" class="hover:text-sky-600 transition">Planes</a>
            <a data-nav data-role="admin-only" href="/admin/planned_entries" class="hover:text-sky-600 transition">Compromisos</a>
            <a data-nav data-role="admin-only" href="/admin/transactions" class="hover:text-sky-600 transition">Movimientos</a>
            <a data-nav data-role="admin-only" href="/admin/forecasts" class="hover:text-sky-600 transition">Pronósticos</a>
            <a data-nav href="/tiempo" class="hover:text-sky-600 transition">Tiempo</a>
            <a data-nav href="/pdf" class="hover:text-sky-600 transition">PDF Typst</a>
            <div class="relative" id="companySwitcher">
              <button id="companyToggle" class="inline-flex items-center gap-1 rounded-md border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:border-sky-300 hover:text-sky-700">
                <span id="companyActiveName">Compañía</span>
                <svg class="h-3 w-3" viewBox="0 0 10 6" fill="none" stroke="currentColor">
                  <path d="M1 1l4 4 4-4" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round" />
                </svg>
              </button>
              <div id="companyMenu" class="absolute right-0 mt-1 w-56 origin-top-right rounded-md border border-slate-200 bg-white shadow-lg ring-1 ring-slate-200 hidden">
                <div id="companyList" class="py-1 text-sm text-slate-700"></div>
              </div>
            </div>
            <button id="logoutNav" class="inline-flex items-center rounded-md border border-slate-200 bg-white px-3 py-1.5 text-xs font-semibold text-slate-700 shadow-sm hover:border-rose-200 hover:text-rose-600">
              Salir
            </button>
          </div>
        </div>
      </nav>
    </header>
    <main class="mx-auto w-full flex-1 px-4 py-10 flex flex-col">
      {% block content %}{% endblock %}
    </main>
  </div>
  <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
  <script>
    (function () {
      const toIso = (date) => {
        const iso = date.toISOString();
        return iso.endsWith(".000Z") ? iso.replace(".000Z", "Z") : iso;
      };

      const parseIso = (value) => {
        if (!value) return null;
        const parsed = new Date(value);
        return isNaN(parsed.getTime()) ? null : parsed;
      };

      const pickerOptions = {
        enableTime: true,
        time_24hr: true,
        altInput: true,
        altFormat: "j M Y, H:i",
        altInputClass: "block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm transition focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40",
        allowInput: true,
        defaultHour: 12,
        defaultMinute: 0,
        dateFormat: "Z",
        formatDate: (date) => toIso(date),
        parseDate: (datestr) => parseIso(datestr),
        onChange: (selectedDates, _dateStr, instance) => {
          if (selectedDates[0]) {
            instance.input.value = toIso(selectedDates[0]);
          }
        },
        onReady: (_selectedDates, _dateStr, instance) => {
          const preset = parseIso(instance.input.value);
          if (preset) {
            instance.setDate(preset, false);
            instance.input.value = toIso(preset);
          }
        },
      };

      document.addEventListener("DOMContentLoaded", () => {
        if (!window.flatpickr) return;
        document.querySelectorAll("[data-datetime-picker]").forEach((input) => {
          flatpickr(input, pickerOptions);
        });
      });
    })();
  </script>
  {% block scripts %}{% endblock %}
  <script>
    (() => {
      // Resaltar link activo del navbar
      const currentPath = window.location.pathname;
      const links = document.querySelectorAll("a[data-nav]");
      links.forEach((link) => {
        const href = link.getAttribute("href") || "";
        const isRoot = href === "/" && currentPath === "/";
        const isMatch =
          isRoot ||
          (href !== "/" && currentPath.startsWith(href));
        if (isMatch) {
          link.classList.add(
            "text-sky-700",
            "font-semibold",
            "bg-sky-50",
            "rounded-md",
            "px-2",
            "py-1",
            "shadow-sm"
          );
        }
      });

      const navAuth = document.getElementById("navAuth");
      const logoutButtons = Array.from(document.querySelectorAll("#logoutNav"));
      const toggle = document.getElementById("companyToggle");
      const menu = document.getElementById("companyMenu");
      const list = document.getElementById("companyList");
      const activeName = document.getElementById("companyActiveName");
      if (!toggle || !menu || !list || !activeName || !navAuth) return;

      const applyRoleVisibility = (isAdmin) => {
        document.querySelectorAll("[data-role='admin-only']").forEach((el) => {
          el.classList.toggle("hidden", !isAdmin);
        });
      };

      const currentHost = window.location.host;
      const baseDomain = (() => {
        const parts = currentHost.split(".");
        if (parts.length >= 3) {
          parts.shift();
          return parts.join(".");
        }
        return currentHost;
      })();

      const setNavVisible = (visible) => {
        navAuth.classList.toggle("hidden", !visible);
      };

      const doLogout = async () => {
        try {
          const res = await fetch("/logout", { method: "POST", credentials: "same-origin" });
          const redirectHost = baseDomain || currentHost;
          window.location.href = `${window.location.protocol}//${redirectHost}/`;
          return res.ok;
        } catch (_) {
          const redirectHost = baseDomain || currentHost;
          window.location.href = `${window.location.protocol}//${redirectHost}/`;
          return false;
        }
      };

      logoutButtons.forEach((btn) => {
        btn?.addEventListener("click", (e) => {
          e.preventDefault();
          doLogout();
        });
      });

      const switchTo = (slug) => {
        const newHost = baseDomain.includes("localhost")
          ? `${slug}.${baseDomain}`
          : `${slug}.${baseDomain}`;
        window.location.href = `${window.location.protocol}//${newHost}${window.location.pathname}${window.location.search}`;
      };

      const renderList = (items) => {
        list.innerHTML = items
          .map(
            (c) => `
              <button data-slug="${c.slug}"
                class="flex w-full items-center justify-between px-3 py-2 text-left hover:bg-slate-50 ${c.active ? "bg-sky-50 text-sky-700" : ""}">
                <span>${c.name}</span>
                ${c.active ? '<span class="text-[11px] font-semibold text-sky-600">Activo</span>' : ""}
              </button>
            `
          )
          .join("");
        const active = items.find((c) => c.active);
        if (active) {
          activeName.textContent = active.name;
        }
        list.querySelectorAll("button").forEach((btn) => {
          btn.addEventListener("click", () => {
            const slug = btn.dataset.slug;
            if (slug) switchTo(slug);
          });
        });
      };

      const fetchCompanies = async () => {
        try {
          const res = await fetch("/api/me/companies", { credentials: "same-origin" });
          if (!res.ok) return;
          const data = await res.json();
          renderList(data);
        } catch (e) {
          console.error("company fetch failed", e);
        }
      };

      const checkAuth = async () => {
        try {
          const res = await fetch("/setup", { credentials: "same-origin" });
          if (!res.ok) {
            setNavVisible(false);
            applyRoleVisibility(false);
            return;
          }
          const data = await res.json();
          const isAdmin = (data.role || "").toLowerCase() === "admin";
          applyRoleVisibility(isAdmin);
          setNavVisible(true);
        } catch (_) {
          setNavVisible(false);
          applyRoleVisibility(false);
        }
      };

      toggle.addEventListener("click", () => {
        menu.classList.toggle("hidden");
      });
      document.addEventListener("click", (e) => {
        if (!menu.contains(e.target) && !toggle.contains(e.target)) {
          menu.classList.add("hidden");
        }
      });

      setNavVisible(false);
      checkAuth().then(fetchCompanies);
    })();
  </script>
</body>
</html>
