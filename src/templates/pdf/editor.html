{% extends "layouts/base.html" %}

{% block title %}Editor PDF Typst{% endblock %}

{% block content %}
  <div class="space-y-6">
    <header class="flex flex-col gap-2">
      <h1 class="text-2xl font-semibold text-slate-800">Generador PDF con Typst</h1>
      <p class="text-sm text-slate-500">Escribe tu documento en Typst y visualiza el PDF al instante. Se requiere tener el binario <code class="font-mono">typst</code> instalado en el servidor.</p>
    </header>

    <div class="grid gap-6 lg:grid-cols-2">
      <section class="flex h-[70vh] flex-col">
        <label for="source" class="mb-2 text-sm font-medium text-slate-600">Markup Typst</label>
        <textarea id="source" name="source" class="h-full w-full flex-1 resize-none rounded-md border border-slate-300 bg-white px-4 py-3 font-mono text-sm shadow-sm focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" placeholder="Escribe tu documento aquí...">
#show: page.with(
  margin: 20pt,
  footer: context [
    #set align(right)
    #set text(8pt)
    #counter(page).display(
      "Thank you for your business · 1 of I",
      both: true,
    )
  ]
)

#let title_left = "Research Warrant"
#let title_right = "INVOICE"

#let sender_name = "Luis Alfredo Rivera Acuna"
#let sender_addr1 = "Villa Libanes #15, col. villas del mediterraneo"
#let sender_addr2 = "Hermosillo, Sonora, Mexico"
#let sender_email = "1alfredorivera@gmail.com"
#let sender_phone = "526623271123"
#let sender_rfc = "RIAL8909172J3"

#let meta_date_label = "DATE"
#let meta_date_value = "10/27/2025"
#let meta_inv_label = "INVOICE NO."
#let meta_inv_value = "RW0030"

#let bill_to_1 = "Research Warrant LLC"
#let bill_to_2 = "110 SE 6TH ST Suite 1700"
#let bill_to_3 = "Fort Lauderdale, Condado de Broward 33301"
#let bill_to_4 = "United States"

#let pay_to_1 = "Research Warrant LLC"
#let pay_to_2 = "WISE EUR BALANCE:"
#let pay_to_3 = "87-1610351"
#let pay_to_4 = "1alfredorivera@gmail.com"

#table(
  columns: (1fr, auto),
  align: (left, right),
  stroke: 0pt,
  [#text(1.3em, strong[#title_left])],
  [#text(1.3em, strong[#title_right])],
)

#v(8pt)

#table(
  columns: (1fr, 1fr),
  align: (left, right),
  stroke: 0pt,
  [
    #strong[#sender_name]
    #linebreak()
    #sender_addr1
    #linebreak()
    #sender_addr2
    #linebreak()
    #link("mailto:" + sender_email)[#sender_email]
  ],
  [
    #table(
      columns: (auto, auto),
      align: (left, right),
      stroke: 0pt,
      [#meta_date_label],[#strong[#meta_date_value]],
      [#meta_inv_label],[#strong[#meta_inv_value]],
    )
  ],
)

#v(10pt)
#line()
#v(10pt)

#table(
  columns: (1fr, 1fr),
  align: (left, left),
  stroke: 0pt,
  [
    #strong[BILL TO]
    #linebreak()
    #bill_to_1
    #linebreak()
    #bill_to_2
    #linebreak()
    #bill_to_3
    #linebreak()
    #bill_to_4
  ],
  [
    #strong[PAY TO]
    #linebreak()
    #pay_to_1
    #linebreak()
    #pay_to_2
    #linebreak()
    #pay_to_3
    #linebreak()
    #pay_to_4
  ],
)

#v(14pt)

#table(
  columns: (2fr, auto, auto, auto),
  align: (left, right, right, right),
  inset: 6pt,
  stroke: 0.35pt,

  table.header[
    #strong[DESCRIPTION]
  ][
    #strong[HOURS]
  ][
    #strong[UNIT PRICE]
  ][
    #strong[TOTAL]
  ],

  [Senior Software Engineering Services - 10/13/2025 - 10/26/2025],
  [81],
  [€48.50],
  [€3,928.50],

  [],[],[€0.00],[€0.00],
  [],[],[€0.00],[€0.00],
  [],[],[€0.00],[€0.00],
  [],[],[€0.00],[€0.00],
)

#v(12pt)

#table(
  columns: (1fr, auto),
  align: (left, right),
  stroke: 0pt,

  [
    #strong[Remarks / Payment Instructions:]
    #linebreak()
    Please send payment via Wise to the following EUR balance:
    #linebreak()
    Account name: Research Warrant LLC
    #linebreak()
    Balance: Wise EUR
    #linebreak()
    Account number: 87-1610351
    #linebreak()
    Recipient email: #link("mailto:" + pay_to_4)[#pay_to_4]
  ],

  [
    #table(
      columns: (auto, auto),
      align: (left, right),
      stroke: 0pt,
      [SUBTOTAL],[#strong[€3,928.50]],
      [TAX RATE],[€0.00],
      [TOTAL TAX],[€0.00],
      [Balance Due],[#strong[€3,928.50]],
    )
  ],
)

#v(10pt)
#line()
#v(6pt)

        
        </textarea>
      </section>

      <section class="flex h-[70vh] flex-col">
        <div class="mb-2 flex items-center justify-between">
          <div>
            <p class="text-sm font-medium text-slate-600">Vista previa</p>
            <p id="error-box" class="text-xs text-rose-500"></p>
          </div>
          <button id="download-btn" type="button" disabled class="rounded-md border border-slate-300 px-3 py-1.5 text-xs font-semibold text-slate-500 transition disabled:cursor-not-allowed disabled:opacity-60 hover:border-sky-400 hover:text-sky-600">Descargar</button>
        </div>
        <iframe id="pdf-frame" title="PDF preview" class="h-full w-full flex-1 rounded-md border border-slate-200 bg-white shadow-inner"></iframe>
      </section>
    </div>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const textarea = document.getElementById('source');
    const frame = document.getElementById('pdf-frame');
    const errorBox = document.getElementById('error-box');
    const downloadBtn = document.getElementById('download-btn');

    let debounceHandle = null;
    let currentBlobUrl = null;
    let requestCounter = 0;

    function setError(message) {
      errorBox.textContent = message || '';
    }

    function revokeBlob() {
      if (currentBlobUrl) {
        URL.revokeObjectURL(currentBlobUrl);
        currentBlobUrl = null;
      }
    }

    function updatePdfFromBase64(base64) {
      const binary = atob(base64);
      const len = binary.length;
      const bytes = new Uint8Array(len);
      for (let i = 0; i < len; i++) {
        bytes[i] = binary.charCodeAt(i);
      }
      revokeBlob();
      const blob = new Blob([bytes], { type: 'application/pdf' });
      currentBlobUrl = URL.createObjectURL(blob);
      frame.src = currentBlobUrl;
      downloadBtn.disabled = false;
      downloadBtn.onclick = () => {
        const link = document.createElement('a');
        link.href = currentBlobUrl;
        link.download = 'preview.pdf';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
      };
    }

    async function sendPreview(content) {
      requestCounter += 1;
      const currentRequest = requestCounter;
      try {
        const response = await fetch('/pdf/preview', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ source: content })
        });
        const data = await response.json();
        if (currentRequest !== requestCounter) {
          return;
        }
        if (data.ok) {
          setError('');
          updatePdfFromBase64(data.pdf_base64);
        } else {
          revokeBlob();
          frame.removeAttribute('src');
          downloadBtn.disabled = true;
          setError(data.error || 'No se pudo generar el PDF');
        }
      } catch (err) {
        revokeBlob();
        frame.removeAttribute('src');
        downloadBtn.disabled = true;
        setError('Error de red generando el PDF');
      }
    }

    function schedulePreview() {
      clearTimeout(debounceHandle);
      debounceHandle = setTimeout(() => {
        sendPreview(textarea.value);
      }, 400);
    }

    textarea.addEventListener('input', schedulePreview);
    window.addEventListener('DOMContentLoaded', () => {
      schedulePreview();
    });
  </script>
{% endblock %}
