{% extends "layouts/base.html" %}

{% block title %}Inicio{% endblock %}

{% block content %}
  <div class="flex flex-col items-center gap-6">
    <section id="session-card" class="w-full max-w-xl rounded-lg border border-slate-200 bg-white p-6 shadow-sm" hidden>
      <div class="flex flex-wrap items-center justify-between gap-3">
        <div>
          <p class="text-sm font-medium text-slate-500">Estado de sesión</p>
          <p id="status" class="mt-1 text-lg font-semibold text-slate-800">No autenticado</p>
        </div>
        <button id="logout-button" type="button" hidden
          class="inline-flex items-center rounded-md border border-rose-200 bg-rose-500 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-rose-600 focus:outline-none focus-visible:ring-2 focus-visible:ring-rose-500 focus-visible:ring-offset-2">
          Cerrar sesión
        </button>
      </div>
    </section>

    <form id="login-form" class="w-full max-w-xl space-y-5 rounded-lg border border-slate-200 bg-white p-6 shadow-sm">
      <header>
        <h1 class="text-xl font-semibold text-slate-800">Ingresa con tu código TOTP</h1>
        <p class="mt-1 text-sm text-slate-500">Introduce tu correo y el código de tu autenticador.</p>
      </header>

      <div class="space-y-2">
        <label for="email" class="block text-sm font-medium text-slate-600">Email</label>
        <input id="email" name="email" type="email" required autocomplete="email"
          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm transition focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" />
      </div>

      <div class="space-y-2">
        <label for="code" class="block text-sm font-medium text-slate-600">Código TOTP</label>
        <input id="code" name="code" inputmode="numeric" pattern="\d*" required autocomplete="one-time-code"
          class="block w-full rounded-md border border-slate-300 bg-white px-3 py-2 text-sm shadow-sm transition focus:border-sky-500 focus:outline-none focus:ring-2 focus:ring-sky-500/40" />
      </div>

      <button type="submit"
        class="inline-flex w-full items-center justify-center rounded-md bg-sky-600 px-4 py-2 text-sm font-semibold text-white shadow-sm transition hover:bg-sky-700 focus:outline-none focus-visible:ring-2 focus-visible:ring-sky-500 focus-visible:ring-offset-2">
        Entrar
      </button>
    </form>

    <pre id="result" class="w-full max-w-xl rounded-lg bg-slate-900 p-4 text-sm text-slate-100 shadow-inner"></pre>
  </div>
{% endblock %}

{% block scripts %}
  <script>
    const form = document.getElementById('login-form');
    const result = document.getElementById('result');
    const statusEl = document.getElementById('status');
    const logoutBtn = document.getElementById('logout-button');
    const sessionCard = document.getElementById('session-card');
    const STORAGE_KEY = 'currentEmail';

    function setStatus(text) {
      statusEl.textContent = text;
    }

    function toggleLogout(visible) {
      logoutBtn.hidden = !visible;
    }

    function toggleSessionCard(visible) {
      sessionCard.hidden = !visible;
    }

    async function checkSession() {
      try {
        const response = await fetch('/setup', {
          method: 'GET',
          credentials: 'same-origin'
        });
        if (response.ok) {
          const data = await response.json();
          setStatus(`Autenticado como ${data.email} (${data.company})`);
          toggleLogout(true);
          toggleSessionCard(true);
          localStorage.setItem(STORAGE_KEY, data.email);
          if (form.email) {
            form.email.value = data.email;
          }
        } else if (response.status === 401 || response.status === 403) {
          localStorage.removeItem(STORAGE_KEY);
          setStatus('No autenticado');
          toggleLogout(false);
          toggleSessionCard(false);
        } else {
          setStatus('Sesión desconocida');
          toggleLogout(false);
          toggleSessionCard(false);
        }
      } catch (err) {
        setStatus('Error consultando sesión');
        toggleLogout(false);
        toggleSessionCard(false);
      }
    }

    form.addEventListener('submit', async (event) => {
      event.preventDefault();
      const body = {
        email: form.email.value.trim(),
        code: form.code.value.trim()
      };

      try {
        const response = await fetch('/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'same-origin',
          body: JSON.stringify(body)
        });
        const text = await response.text();
        try {
          const data = JSON.parse(text);
          if (response.ok && data.ok) {
            result.textContent = 'Login correcto';
            localStorage.setItem(STORAGE_KEY, body.email);
            await checkSession();
            return;
          }
          if (data && data.error) {
            result.textContent = data.error;
          } else {
            result.textContent = text;
          }
        } catch (_) {
          result.textContent = text;
        }
      } catch (err) {
        result.textContent = 'Error enviando login';
      }
    });

    logoutBtn.addEventListener('click', async () => {
      try {
        const response = await fetch('/logout', {
          method: 'POST',
          credentials: 'same-origin'
        });
        toggleLogout(false);
        toggleSessionCard(false);
        if (response.ok) {
          result.textContent = 'Sesión cerrada';
          setStatus('No autenticado');
          localStorage.removeItem(STORAGE_KEY);
        } else {
          const text = await response.text();
          result.textContent = text || 'Error al cerrar sesión';
          setStatus('No autenticado');
        }
      } catch (err) {
        result.textContent = 'Error al cerrar sesión';
      }
    });

    const savedEmail = localStorage.getItem(STORAGE_KEY);
    if (savedEmail && form.email) {
      form.email.value = savedEmail;
    }
    checkSession();
  </script>
{% endblock %}
